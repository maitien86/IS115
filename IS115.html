<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Bubble Picker - Hand Tracking Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #1b2735, #000); font-family: 'Segoe UI', sans-serif; color: white; }
        canvas#bubbleCanvas { display: block; }
        
        #selection-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: #090a0f; }
        .section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section-btn { width: 120px; height: 120px; font-size: 1.5rem; border: 2px solid #00d2ff; border-radius: 15px; background: none; color: #00d2ff; cursor: pointer; }

        /* CAMERA DEBUG WINDOW */
        #video-panel { position: fixed; bottom: 20px; right: 20px; width: 240px; height: 180px; border: 2px solid #00d2ff; border-radius: 10px; overflow: hidden; z-index: 100; background: #000; }
        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; transform: scaleX(-1); } /* Mirror effect */
        #gesture-label { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 2px 8px; font-size: 12px; color: #00ff00; border-radius: 4px; }

        #game-ui { display: none; }
        .back-btn { position: fixed; top: 20px; right: 20px; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #fff; color: #fff; border-radius: 5px; cursor: pointer; z-index: 500; }
        #winner-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 40px; border-radius: 30px; text-align: center; display: none; z-index: 200; border: 1px solid rgba(255,255,255,0.2); }
        h1 { color: #00d2ff; font-size: 3rem; margin: 10px 0; }
    </style>
</head>
<body>

<div id="selection-screen">
    <h2>SELECT YOUR SECTION</h2>
    <div class="section-grid">
        <button class="section-btn" onclick="startSection('G1')">G1</button>
        <button class="section-btn" onclick="startSection('G2')">G2</button>
        <button class="section-btn" onclick="startSection('G3')">G3</button>
        <button class="section-btn" onclick="startSection('G4')">G4</button>
    </div>
</div>

<div id="game-ui">
    <button class="back-btn" onclick="location.reload()">‚Üê Restart App</button>
    <div id="video-panel">
        <div id="gesture-label">DETECTING...</div>
        <canvas id="output_canvas"></canvas>
    </div>
    <div id="winner-overlay">
        <p>SELECTED STUDENT</p>
        <h1 id="winner-name">Name</h1>
        <button onclick="document.getElementById('winner-overlay').style.display='none'" style="padding:10px 20px; cursor:pointer;">Close</button>
    </div>
    <video id="input_video"></video>
    <canvas id="bubbleCanvas"></canvas>
</div>

<script>
const sectionData = {
    "G1": ["DEX NGIAM CHAO YI", "CHIN JUN WEN", "JAY YEO JUN JIE", "PUA JUN RONG DARYL", "ANG CHENG ZUO", "TAN GUAN WEI", "HAN JING KWANG YULE", "ATHITHYA S P", "CHEW KUO KAI REGEN", "JAYDON SOONG YU CHEN", "DEBESH AHMED SO ASARAF ALI", "TAN RAY YIEN", "MAO CHENG FONG", "HUI HON YEUNG SHAWN", "MAS LUTFIR RAHMAN BIN JUMARI", "IRWIN SIM", "JEREMIAH CHIN WON CHUH", "WONG LIANG HAO JEROME", "TAN JUN SHENG", "LEONG ZHI XIN ISAAC", "TAY CHIN YOU", "TRAN NHAT QUANG", "SONYA LOW YA XUAN", "LIN LEJING FANNY", "JACKSON LOH XU TAO", "ZHANG JINYAN", "HENG ZHENG LIN DYLAN", "LIM YAN XI RACHEL", "ROWENA SIM PUI YEE", "SOH SWEE MIN", "OH ERN QI", "ANGEL CHEY EE ZIA", "TEO YI TING", "TAN ZI XUAN JANICE", "KARIN TAN SZE YU", "JHENUEL RINOAH BATAC BACSAL", "THADDEUS TAN WEN JIE", "WU YUJIA", "ALECIA TIRTA CHING HSIA GOOI", "NGUYEN HA ANH", "SHREYA NINAD GADKARI", "NG ERN KHAI JOSHUA", "LEE YIN QI LAURA"],
    "G2": ["CHAN DING HAO", "HARI NARAYANAN SURESH", "ONG JUN HONG", "ZAI SHUN YU ZACHARY", "ARIQ LIM KIAT SIANG", "TAN YAN TAT", "IAN PONG", "LU JIA-HONG", "WONG JING ZHI PHILBERT", "JIANG YIT FONG", "HANAFI SANI", "RYAN YANG CHNG YU", "TAN HOU HUA DONALD", "NGO XIAN EN", "CESAR CHEN PERALTA JR II", "MAKENDRA PRASAD SUBRAMANIAN", "MARCUS CHIAM HAO YI", "AW BING XIAN", "ZACHARY ANDREW TEO FU JUN", "LIEW YU CHEN", "JONATHAN LEOW GUAN WEI", "NELVIN TAN JIA LIANG", "BERNARD LO", "MATTHEW TJANDERA", "JAVERINE TAN JING XUAN", "LIORA LIVIA NG", "HOMME JAEMIN", "FANG YUTONG", "SEOW WEE YEE VIVIENNE", "LEE JI HAO", "NUR YAZLINA BINTE AHMAD YAZID", "MUHAMMAD HAIKAL BIN MOHD SOBERI", "ARYAN AMIT KASHIKAR", "HOANG QUYNH CHI", "TARUNIKAA SARAVANAN VIJAYADHANALAKSHMI", "GERMAINE FOO EE HUEI", "SU PYAE PYAE ZAW", "TERESA NG YANG NI", "TAN TZE YIN VALENCIA", "EMILEY J WILLIAMS", "LEE JUN WEI", "MUDIT GUPTA", "HUANG CHUJUN", "LIM ZHI YU"],
    "G3": ["LOKE HAN SHEN", "SOMESH BALAMURUGAN", "ALDEN WONG CHONG YAN", "JOASH LAW CHO SHUEN", "CRUZ CHUA", "JAMES YAP XU HENG", "LEONG MING LIANG TIMOTHY", "KAVEN TAN KENG HENG", "MOHAMED ISTHIAQ MOHAMED FAROOK", "HAW YAN TZER", "HO ZHI YANG", "KEVAN SEAH PENG HONG", "DAVID AMMIEL WAN", "HUANG YONGXIANG", "ISSAC LAW CHI YEUNG", "FANG KAICONG", "MUHAMMAD FARHAAN SO HAJA MOHIDEEN", "KIERAN RYAN THAM EE JU-UN", "LIAU JUN SHENG", "LEE WEN KHAI JOSHUA", "THANESH SO SATHTHI", "KUMARAN DHANDAPANI", "LEE TYLER", "PEH DING HAO PAULINE", "ALEXANDER JUDE TAN", "CHAN JING RONG", "SHERRYAN SOO TINGXUAN", "JENNIFER JANE BURNS", "CASSANDRA KAYE PEREZ BONZON", "JESSIE TAN JIEYU", "NG YU QI", "YEE WAN SIM", "LOW TZE HAN DEXTER", "KAYRA ZALFA ALIMAA", "EUGENE ANG WEI KIAT", "LIM KE QING CHARLOTTE", "HARINI NARASA ANANTHA NARAYANAN", "MAEGAN KHOO ANN", "SWAN HTET AUNG", "BERITH CHAI YI LE", "AISHANI SAHOO", "NATALIE TUNG QIHUI"],
    "G4": ["PHUA KIA HENG", "LEE CHERNG KIAT RYAN", "SHOBAN RAJ SO RAJAMOGN", "SETH TAN YU ZHI", "BRIAN SNG", "LEONG YEW KAI", "EASHVAR RAMANAN", "CHUNG YI KAI COEN", "ISAAC HIEW YI HE", "HENG HONG LI", "NOAH GAN", "CHOO JIUN WEI", "SIOW CHIN YUONG", "TAN HIANG JOON GABRIEL", "KIRUBAN SO PRAGATHESVARAN", "LEE JIA LE", "RISHABH SATISH", "TIMOTHY CHAN JIA SHENG", "ONG YU KAI JAVIER", "THET HTAR NWE", "SUI RUIRONG", "EZEKIEL TAN SIYONG", "ADHITYA", "ALLISON MARGARET LOO LI HOUNG", "TAN KAI XIN", "LWIN MOE HTET", "TANG YI XIN SAMANTHA", "NATALIE SOPHIE CHUA XUN", "BUI TIEN MINH", "LEE SUNG-WON", "LEW JING YUAN", "SANJANA SARAVANAN", "MICHELLE FLORENCE PRATAMA TJIANG", "KOH JIAXIN GERALDINE", "KHOO JING WEI", "GABRIELE GIACOMIN", "LEE TZU RUI", "WILLIAM HANSEL", "CHEN PEI NEE", "WONG WING YEE", "LIM PEI JIE KATHLEEN"]
};

const canvas = document.getElementById('bubbleCanvas');
const ctx = canvas.getContext('2d');
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const label = document.getElementById('gesture-label');

let width, height, bubbles = [], isShuffling = false, lastFistState = false;

function initBubbles(names) {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    bubbles = names.map(name => ({
        x: Math.random() * width, y: Math.random() * height, z: Math.random(),
        baseRadius: 50 + Math.random() * 20, vx: (Math.random() - 0.5) * 2, vy: (Math.random() - 0.5) * 2,
        name: name, hue: Math.random() * 360
    }));
}

function animate() {
    if (document.getElementById('game-ui').style.display === 'none') return;
    ctx.clearRect(0, 0, width, height);
    bubbles.sort((a, b) => b.z - a.z);
    bubbles.forEach(b => {
        let scale = 1 / (1 + b.z * 1.5); let r = b.baseRadius * scale;
        if (isShuffling) {
            let dx = width/2 - b.x, dy = height/2 - b.y; let angle = Math.atan2(dy, dx);
            b.vx += Math.cos(angle + Math.PI/2) * 2.5 + dx * 0.006; b.vy += Math.sin(angle + Math.PI/2) * 2.5 + dy * 0.006;
            b.vx *= 0.94; b.vy *= 0.94;
        } else {
            if (b.x + r > width || b.x - r < 0) b.vx *= -1;
            if (b.y + r > height || b.y - r < 0) b.vy *= -1;
        }
        b.x += b.vx * scale; b.y += b.vy * scale;
        drawBubble(b, r, scale);
    });
    requestAnimationFrame(animate);
}

function drawBubble(b, r, scale) {
    ctx.save(); ctx.globalAlpha = 0.4 + (0.6 * scale);
    let grad = ctx.createRadialGradient(b.x, b.y, r*0.5, b.x, b.y, r);
    grad.addColorStop(0, `hsla(${b.hue}, 80%, 90%, 0)`); grad.addColorStop(1, `hsla(${b.hue}, 100%, 80%, 0.7)`);
    ctx.beginPath(); ctx.arc(b.x, b.y, r, 0, Math.PI*2); ctx.fillStyle = grad; ctx.fill();
    ctx.fillStyle = "white"; ctx.font = `bold ${Math.max(10, 18*scale)}px Arial`;
    ctx.textAlign="center"; ctx.fillText(b.name, b.x, b.y+5); ctx.restore();
}

function startSection(section) {
    document.getElementById('selection-screen').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    initBubbles(sectionData[section]);
    animate();
    camera.start();
}

// HAND TRACKING CODE
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

hands.onResults((results) => {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        // DRAW THE SKELETON
        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
        drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});

        // FIST LOGIC: Check if fingertips are lower than knuckles
        const isFist = landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y;
        label.innerText = isFist ? "‚úä FIST (SHUFFLING)" : "üñêÔ∏è OPEN (STOPPED)";
        label.style.color = isFist ? "#ff00ff" : "#00ff00";

        if (isFist && !lastFistState) { isShuffling = true; document.getElementById('winner-overlay').style.display='none'; }
        else if (!isFist && lastFistState) { 
            isShuffling = false; 
            const winner = bubbles[Math.floor(Math.random()*bubbles.length)];
            document.getElementById('winner-name').innerText = winner.name;
            document.getElementById('winner-overlay').style.display = 'block';
        }
        lastFistState = isFist;
    } else {
        label.innerText = "NO HAND DETECTED";
        label.style.color = "red";
    }
    canvasCtx.restore();
});

const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 640, height: 480
});

window.addEventListener('resize', () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; });
</script>
</body>
</html>